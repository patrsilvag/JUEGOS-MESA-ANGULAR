<!-- Encabezado -->
<section class="bg-light border-bottom py-3">
  <div class="container">
    <h1 class="h4 mb-0">üõí Carrito de Compras</h1>
  </div>
</section>

<main class="container my-4">

  <!-- Carrito vac√≠o -->
  <div class="alert alert-info text-center" *ngIf="(carritoLista?.length ?? 0) === 0">
    Tu carrito est√° vac√≠o.
  </div>

  <!-- Carrito con productos -->
  <div class="row gy-4" *ngIf="(carritoLista?.length ?? 0) > 0">

    <!-- ============================
         MOBILE (<768px) - CARDS
         ============================ -->
    <div class="col-12 d-block d-md-none">
      <div *ngFor="let p of carritoLista" class="item-card">

        <div class="item-header">
          <img [src]="p.imagen" [alt]="p.nombre" />
          <h5>{{ p.nombre }}</h5>
        </div>

        <div class="item-row">
          <span class="label">Precio</span>
          <span class="value">$ {{ p.precio | number }}</span>
        </div>

        <div class="item-row">
          <span class="label">Cantidad</span>
          <div class="cantidad-controls">
            <button (click)="restar(p.id)">‚àí</button>
            <span>{{ p.cantidad }}</span>
            <button (click)="sumar(p.id)">+</button>
          </div>
        </div>

        <div class="item-row">
          <span class="label">Subtotal</span>
          <span class="value fw-bold">$ {{ p.cantidad * p.precio | number }}</span>
        </div>

        <button class="btn-eliminar" (click)="quitar(p.id)">Eliminar</button>

      </div>
    </div>

    <!-- ============================
         TABLET / DESKTOP (‚â•768px)
         ============================ -->
    <div class="col-12 col-lg-8 d-none d-md-block">
      <div class="card shadow-sm p-0">
        <div class="tabla-scroll">
          <table class="table align-middle mb-0">
            <thead class="table-dark">
              <tr>
                <th>Producto</th>
                <th class="text-end">Precio</th>
                <th class="text-center">Cant.</th>
                <th class="text-end">Subtotal</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of carritoLista">
                <td class="producto-col">
                  <img [src]="p.imagen" [alt]="p.nombre" />
                  <span>{{ p.nombre }}</span>
                </td>

                <td class="text-end">$ {{ p.precio | number }}</td>

                <td class="text-center">
                  <div class="cantidad-controls">
                    <button (click)="restar(p.id)">‚àí</button>
                    <span>{{ p.cantidad }}</span>
                    <button (click)="sumar(p.id)">+</button>
                  </div>
                </td>

                <td class="text-end fw-bold">$ {{ p.cantidad * p.precio | number }}</td>

                <td class="text-center">
                  <button class="btn-eliminar" (click)="quitar(p.id)">Eliminar</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ============================
         RESUMEN + CUP√ìN INTEGRADO
         ============================ -->
    <div class="col-12 col-lg-4">
      <div class="resumen-box">

        <h3>Resumen</h3>

        <!-- SUBTOTAL ORIGINAL -->
        <div class="linea">
          <span>Subtotal:</span>
          <strong>$ {{ subtotalOriginal() | number }}</strong>
        </div>

        <!-- DESCUENTO (solo si existe) -->
        <div class="linea" *ngIf="subtotalOriginal() !== total()">
          <span>Descuento:</span>
          <strong class="text-success">
            - $ {{ (subtotalOriginal() - total()) | number }}
          </strong>
        </div>

        <!-- SUBTOTAL FINAL (con descuento) -->
        <div class="linea">
          <span>Subtotal con descuento:</span>
          <strong>$ {{ total() | number }}</strong>
        </div>

        <!-- ENV√çO -->
        <div class="linea">
          <span>Env√≠o:</span>
          <strong>$ {{ envio() | number }}</strong>
        </div>

        <hr />

        <!-- FORMULARIO CUP√ìN -->
        <form [formGroup]="cuponForm" (ngSubmit)="aplicarCupon()" class="row g-2">

          <div class="col-12">
            <input 
              type="text"
              formControlName="codigoDescuento"
              class="form-control"
              placeholder="Ingresa tu cup√≥n"
            />
            <small class="text-danger"
              *ngIf="
                cuponForm.get('codigoDescuento')?.invalid &&
                cuponForm.get('codigoDescuento')?.dirty
              ">
              Debe tener al menos 4 caracteres.
            </small>
          </div>

          <div class="col-6">
            <button type="submit" class="btn btn-primary w-100">Aplicar</button>
          </div>

          <div class="col-6">
            <button type="button" class="btn btn-secondary w-100" (click)="limpiarCupon()">
              Limpiar
            </button>
          </div>

          <div *ngIf="mensajeCupon" class="alert alert-info mt-2">
            {{ mensajeCupon }}
          </div>

        </form>

        <hr />

        <!-- TOTAL FINAL -->
        <div class="linea total-final">
          <strong>Total:</strong>
          <strong>$ {{ totalFinal() | number }}</strong>
        </div>

        <button class="btn-vaciar mt-2" (click)="limpiarCarrito()">
          Vaciar carrito
        </button>

      </div>
    </div>

  </div>

  <!-- Bot√≥n volver -->
  <div class="text-center mt-4">
    <a routerLink="/" class="btn btn-primary">
      ‚Üê Seguir comprando
    </a>
  </div>

</main>
